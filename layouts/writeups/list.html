{{ define "main" }}

<div class="container">
    <!-- Header Section -->
    <header class="section">
        <div class="card">
            <div class="card-body text-center">
                <h1 class="section-title" style="margin-bottom: var(--spacing-md);">
                    <i class="fas fa-file-code" style="color: var(--primary-color);"></i>
                    {{ .Title }}
                </h1>
                <p class="section-subtitle">{{ .Description }}</p>
                
                <!-- Statistics -->
                <div style="display: flex; justify-content: center; gap: var(--spacing-xl); margin-top: var(--spacing-lg);">
                    <div class="stat-item" style="background: none; box-shadow: none; padding: var(--spacing-md);">
                        <span class="stat-number" style="font-size: var(--font-size-2xl);">{{ len (where .Site.RegularPages "Section" "writeups") }}</span>
                        <span class="stat-label">WriteUps</span>
                    </div>
                    <div class="stat-item" style="background: none; box-shadow: none; padding: var(--spacing-md);">
                        <span class="stat-number" style="font-size: var(--font-size-2xl);">{{ len .Site.Taxonomies.categories }}</span>
                        <span class="stat-label">Catégories</span>
                    </div>
                    <div class="stat-item" style="background: none; box-shadow: none; padding: var(--spacing-md);">
                        <span class="stat-number" style="font-size: var(--font-size-2xl);">{{ len .Site.Taxonomies.ctfs }}</span>
                        <span class="stat-label">CTFs</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Search and Filters Section -->
    <section class="mb-xl">
        <!-- Search Bar -->
        <div class="search-container">
            <input type="text" id="search-input" class="search-input" placeholder="Rechercher dans {{ .Title | lower }}...">
            <i class="fas fa-search search-icon"></i>
        </div>

        <!-- Filters -->
        <div class="filters">
            <button class="filter-btn active" data-filter="all">Tous</button>
            <button class="filter-btn" data-filter="pwn">Pwn</button>
            <button class="filter-btn" data-filter="web">Web</button>
            <button class="filter-btn" data-filter="reverse">Reverse</button>
            <button class="filter-btn" data-filter="network">Network</button>
            <button class="filter-btn" data-filter="crypto">Crypto</button>
        </div>

        <!-- Sort Options -->
        <div style="text-align: center; margin-bottom: var(--spacing-xl);">
            <select id="sort-select" style="padding: var(--spacing-sm) var(--spacing-md); border: 2px solid var(--border-color); border-radius: var(--border-radius-sm); background: var(--bg-card); color: var(--text-primary);">
                <option value="date-desc">Plus récent en premier</option>
                <option value="date-asc">Plus ancien en premier</option>
                <option value="title-asc">Titre A-Z</option>
                <option value="title-desc">Titre Z-A</option>
            </select>
        </div>
    </section>

    <!-- Articles Grid -->
    <section class="mb-xl">
        <div class="grid grid-2" id="articles-grid">
            {{ $writeupPages := where .Site.RegularPages "Section" "writeups" }}
            {{ range $writeupPages.ByDate.Reverse }}
                <article class="card" data-title="{{ .Title | lower }}" data-date="{{ .Date.Format "2006-01-02" }}" data-tags="{{ if .Params.tags }}{{ delimit .Params.tags "," | lower }}{{ end }}" data-categories="{{ if .Params.categories }}{{ delimit .Params.categories "," | lower }}{{ end }}">
                    <div class="card-body">
                        <!-- Meta Information -->
                        <div class="card-meta">
                            <span><i class="fas fa-calendar"></i> {{ .Date.Format "2 January 2006" }}</span>
                            <span><i class="fas fa-clock"></i> {{ .ReadingTime }} min</span>
                            {{ if .Params.ctfs }}
                            <span><i class="fas fa-trophy"></i> {{ index .Params.ctfs 0 | title }}</span>
                            {{ end }}
                        </div>

                        <!-- Title -->
                        <h3 class="card-title">
                            <a href="{{ .RelPermalink }}" style="text-decoration: none; color: inherit;">
                                {{ .Title }}
                            </a>
                        </h3>

                        <!-- Summary -->
                        <p class="card-description">
                            {{ .Summary | truncate 200 }}
                        </p>

                        <!-- Tags -->
                        {{ if .Params.tags }}
                        <div class="card-tags">
                            {{ range first 4 .Params.tags }}
                            <span class="tag {{ if eq . "pwn" }}tag-error{{ else if eq . "web" }}tag-primary{{ else if eq . "reverse" }}tag-success{{ else if eq . "network" }}tag-warning{{ else if eq . "crypto" }}tag-primary{{ else if eq . "shellcode" }}tag-error{{ else if eq . "exploitation" }}tag-error{{ else if eq . "forensics" }}tag-success{{ else if eq . "steganography" }}tag-warning{{ else if eq . "osint" }}tag-primary{{ else if eq . "misc" }}tag-secondary{{ else if eq . "hardware" }}tag-warning{{ else if eq . "mobile" }}tag-success{{ end }}">
                                <i class="fas fa-hashtag" style="font-size: 0.7em; opacity: 0.8; margin-right: 0.2em;"></i>
                                {{ . }}
                            </span>
                            {{ end }}
                            {{ if gt (len .Params.tags) 4 }}
                            <span class="tag" style="background: var(--text-muted); color: var(--text-inverse); font-size: 0.7em;">
                                +{{ sub (len .Params.tags) 4 }}
                            </span>
                            {{ end }}
                        </div>
                        {{ end }}

                        <!-- Categories -->
                        {{ if .Params.categories }}
                        <div style="margin-top: var(--spacing-sm);">
                            {{ range .Params.categories }}
                            <span class="tag tag-primary" style="text-transform: uppercase; font-weight: 600;">
                                <i class="fas fa-folder" style="font-size: 0.7em; opacity: 0.8; margin-right: 0.2em;"></i>
                                {{ . | title }}
                            </span>
                            {{ end }}
                        </div>
                        {{ end }}
                    </div>

                    <div class="card-footer">
                        <a href="{{ .RelPermalink }}" class="btn btn-primary">
                            Lire le WriteUp
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </article>
            {{ end }}
        </div>

        <!-- No Results Message -->
        <div id="no-results" class="text-center" style="display: none; padding: var(--spacing-2xl);">
            <div class="card">
                <div class="card-body">
                    <i class="fas fa-search" style="font-size: var(--font-size-4xl); color: var(--text-muted); margin-bottom: var(--spacing-lg);"></i>
                    <h3 style="color: var(--text-muted); margin-bottom: var(--spacing-md);">Aucun résultat trouvé</h3>
                    <p style="color: var(--text-muted);">Essayez de modifier vos critères de recherche ou filtres.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Categories/Tags Section -->
    {{ if .Site.Taxonomies.ctfs }}
    <section class="section" style="background: var(--bg-secondary); border-radius: var(--border-radius); padding: var(--spacing-2xl); margin-bottom: var(--spacing-xl);">
        <h2 class="section-title">CTFs Couverts</h2>
        <div class="grid grid-4">
            {{ range $name, $taxonomy := .Site.Taxonomies.ctfs }}
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-trophy" style="font-size: var(--font-size-2xl); color: var(--warning-color); margin-bottom: var(--spacing-md);"></i>
                    <h4 class="card-title">{{ $name | title }}</h4>
                    <p style="color: var(--text-muted);">{{ len $taxonomy }} writeups</p>
                    <a href="{{ "/writeups/" | relURL }}{{ $name }}" class="btn btn-sm btn-outline">
                        Voir les writeups
                    </a>
                </div>
            </div>
            {{ end }}
        </div>
    </section>
    {{ end }}
</div>

<!-- Enhanced JavaScript for search, filter, and sort -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const filterBtns = document.querySelectorAll('.filter-btn');
    const sortSelect = document.getElementById('sort-select');
    const articlesGrid = document.getElementById('articles-grid');
    const noResults = document.getElementById('no-results');
    let articles = Array.from(document.querySelectorAll('.card[data-title]'));

    let currentFilter = 'all';
    let currentSort = 'date-desc';
    let currentSearch = '';

    function filterAndSort() {
        let filteredArticles = articles.filter(article => {
            // Search filter
            const title = article.getAttribute('data-title') || '';
            const tags = article.getAttribute('data-tags') || '';
            const categories = article.getAttribute('data-categories') || '';
            
            const searchMatch = currentSearch === '' || 
                                title.includes(currentSearch) || 
                                tags.includes(currentSearch) ||
                                categories.includes(currentSearch);

            // Category filter
            let categoryMatch = false;
            if (currentFilter === 'all') {
                categoryMatch = true;
            } else {
                // Parse tags and categories
                const tagsList = tags ? tags.split(',').map(t => t.trim().toLowerCase()) : [];
                const categoriesList = categories ? categories.split(',').map(c => c.trim().toLowerCase()) : [];
                
                // Priority 1: Check exact match in categories (most reliable)
                categoryMatch = categoriesList.includes(currentFilter.toLowerCase());
                
                // Priority 2: If not found in categories, check in tags
                if (!categoryMatch) {
                    // Check for exact match in tags
                    categoryMatch = tagsList.includes(currentFilter.toLowerCase());
                    
                    // Priority 3: Check for partial matches in tags (for complex tags)
                    if (!categoryMatch) {
                        categoryMatch = tagsList.some(tag => 
                            tag.includes(currentFilter.toLowerCase()) || 
                            currentFilter.toLowerCase().includes(tag)
                        );
                    }
                }
            }

            return searchMatch && categoryMatch;
        });

        // Sort articles
        filteredArticles.sort((a, b) => {
            const aTitle = a.getAttribute('data-title');
            const bTitle = b.getAttribute('data-title');
            const aDate = a.getAttribute('data-date');
            const bDate = b.getAttribute('data-date');

            switch(currentSort) {
                case 'date-asc':
                    return aDate.localeCompare(bDate);
                case 'date-desc':
                    return bDate.localeCompare(aDate);
                case 'title-asc':
                    return aTitle.localeCompare(bTitle);
                case 'title-desc':
                    return bTitle.localeCompare(aTitle);
                default:
                    return bDate.localeCompare(aDate);
            }
        });

        // Hide all articles first
        articles.forEach(article => {
            article.style.display = 'none';
            article.classList.remove('animate-fade-in');
        });

        // Show filtered articles with animation
        filteredArticles.forEach((article, index) => {
            setTimeout(() => {
                article.style.display = 'block';
                article.classList.add('animate-fade-in');
            }, index * 50); // Stagger animation
        });

        // Show/hide no results message
        if (filteredArticles.length === 0) {
            noResults.style.display = 'block';
        } else {
            noResults.style.display = 'none';
        }
        
        // Log results for debugging
        console.log(`Filter: ${currentFilter}, Found: ${filteredArticles.length} articles`);
    }

    // Search functionality
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            currentSearch = e.target.value.toLowerCase();
            filterAndSort();
        });
    }

    // Filter functionality
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.getAttribute('data-filter');
            console.log(`Selected filter: ${currentFilter}`);
            filterAndSort();
        });
    });

    // Sort functionality
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            currentSort = this.value;
            filterAndSort();
        });
    }

    // Initial load
    filterAndSort();
});
</script>

{{ end }} 